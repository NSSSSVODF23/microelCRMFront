<div class="sticky z-5 top-0 h-screen flex flex-column bg-white border-right-1 border-bluegray-100 shadow-1 overflow-hidden">
    <div class="flex flex-column p-3 gap-3">
        <div class="flex gap-2 align-items-center" *ngIf="menuService.currentUser$ | async as user">
            <app-avatar [src]="user.avatar" [name]="user.fullName" [size]="2.2" shape="square"></app-avatar>
            <div class="flex-grow-1 white-space-nowrap">{{user.fullName}}</div>
            <button pButton icon="mdi-more_vert" (click)="menu.toggle($event)"
                    class="p-button-secondary p-button-icon p-button-text w-fit"></button>
        </div>
        <button pButton label="Новая задача" icon="mdi-add_task" (click)="menuService.createTask()"
                class="p-button-success white-space-nowrap"></button>
    </div>
    <div class="flex flex-grow-1">
        <div class="flex flex-column w-full">
            <ng-container *ngFor="let item of menuService.menuModel">
                <app-extended-menu-item [onlyIcon]="!!(menuService.currentSubmenu$ | async)" [caption]="item.caption" [exact]="item.exactMatch ?? false" [icon]="item.icon" [link]="item.link" *ngIf="menuService.hasAccess(item)"></app-extended-menu-item>
            </ng-container>
        </div>
        <div class="flex flex-column" *ngIf="menuService.currentSubmenu$ | async as currentSubmenu">
            <ng-container *ngFor="let item of currentSubmenu">
                <app-extended-menu-item [caption]="item.caption" [exact]="item.exactMatch ?? false" [icon]="item.icon" [link]="item.link" *ngIf="menuService.hasAccess(item)"></app-extended-menu-item>
            </ng-container>
        </div>
    </div>
</div>

<p-menu #menu [model]="menuService.userMenuOptions" [popup]="true" appendTo="body" [baseZIndex]="2000"
        appCloseIfScroll [isVisible]="menu.visible" [alignFn]="menu.alignOverlay.bind(menu)"></p-menu>

<ng-template #buttonTemplate let-caption="caption" let-icon="icon" let-ext="ext" let-styleClass="styleClass" let-click="click">
    <div (click)="click"
         [ngClass]="'flex gap-2 align-items-center p-2 white-space-nowrap select-none outline-none transition-colors' +
          ' transition-duration-150 text-2xl justify-content-center cursor-pointer ' +
           (styleClass ? styleClass : 'text-bluegray-300 hover:bg-bluegray-50 hover:text-bluegray-500')"
    >
        <span [class]="icon"></span>
        <span *ngIf="ext">{{caption}}</span>
    </div>
</ng-template>

<p-dialog [(visible)]="menuService.avatarChangeDialogVisible" [draggable]="false" [modal]="true" [resizable]="false" appendTo="body"
          [dismissableMask]="true" header="Изменить аватар">
    <div class="flex flex-column">
        <div class="flex gap-3 align-items-center justify-content-center p-2">
            <div class="flex gap-2 bg-bluegray-50 border-round-xl text-bluegray-500 align-items-center p-3 font-bold">
                <div class="w-6rem h-6rem border-circle fit-content object-fit-cover bg-bluegray-400 border-1
                 border-bluegray-500 text-white text-xl flex align-items-center justify-content-center" *ngIf="!menuService.croppedImage"><i class="mdi-image"></i></div>
                <img class="w-6rem h-6rem border-circle fit-content object-fit-cover" [src]="menuService.croppedImage" *ngIf="menuService.croppedImage" alt=""/>
                <span>
                    Предпросмотр
                </span>
            </div>
            <div class="flex flex-column gap-2">
                <p-button label="Выбрать" (onClick)="menuService.selectFile(fileInput)" icon="mdi-image" [disabled]="menuService.avatarUpload" styleClass="p-button-text p-button-secondary"></p-button>
                <p-button label="Сохранить" (onClick)="menuService.saveAvatar()" icon="mdi-upload" [loading]="menuService.avatarUpload" [disabled]="!menuService.croppedImage"></p-button>
            </div>
            <input #fileInput (change)="menuService.imageChangedEvent = $event" type="file" [style.display]="'none'" accept="image/jpeg, image/png, image/jpg, image/bmp"/>
        </div>
        <image-cropper
                (imageCropped)="menuService.imageCropped($event)"
                [aspectRatio]="1"
                [cropperMinWidth]="64"
                [cropperMinHeight]="64"
                [imageChangedEvent]="menuService.imageChangedEvent"
                [maintainAspectRatio]="true"
                [style]="{maxWidth: '40vw', minWidth: '15rem', height: 'fit-content'}"
                format="png"
        ></image-cropper>
    </div>
</p-dialog>

<p-dialog [(visible)]="menuService.phyPhoneSelectionDialogVisible" [draggable]="true" [modal]="true" [resizable]="false" appendTo="body"
          [dismissableMask]="true" header="Привязать телефон" contentStyleClass="flex gap-3 align-items-center pt-1">
    <ng-template pTemplate="content">
        <p-dropdown [options]="(menuService.phones$ | async) ?? []" appendTo="body"
                    [formControl]="menuService.phyPhoneControl" [disabled]="menuService.isPhyPhoneIsBinding"></p-dropdown>
        <p-button (onClick)="menuService.bindPhone()" label="Привязать" [loading]="menuService.isPhyPhoneIsBinding"></p-button>
    </ng-template>
</p-dialog>
