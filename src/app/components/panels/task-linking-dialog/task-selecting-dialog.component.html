<p-dialog [(visible)]="isShow" [breakpoints]="{'960px': '90vw', '640px': '100vw'}"
          [draggable]="false" [modal]="true" [resizable]="false" [contentStyle]="dialogContentStyle"
          [style]="{width: '80vw'}" (onHide)="closeHandler()" [header]="header">
    <ng-template pTemplate="content">
        <ng-container *ngIf="linkingMode === 'single'; then parentTaskList else childTaskList"></ng-container>
        <ng-container *ngTemplateOutlet="filter"></ng-container>
        <ng-container *ngTemplateOutlet="paginator"></ng-container>
        <p-button *ngIf="linkingMode==='multiply'" styleClass="p-button-success" class="float-button"
                  (onClick)="selectChild()" label="Выбрать" icon="mdi-check" [disabled]="selectedChildTask.length === 0"></p-button>
        <div class="loading-shader" *ngIf="linkingInProgress">
            <app-circle-loading-indicator></app-circle-loading-indicator>
        </div>
    </ng-template>
</p-dialog>

<!--Список задач для выбора родительской задачи-->
<ng-template #parentTaskList>
    <div class="list">
        <app-task-list-element (onClick)="this.selectParent(task.taskId)" [item]="task" *ngFor="let task of pageOfTasks?.content"
                               [customClickHandler]="true" [fullDate]="true"></app-task-list-element>
    </div>
</ng-template>

<!--Список задач для выбора дочерних задач-->
<ng-template #childTaskList>
    <div class="list">
        <app-task-list-element [(check)]="selectedChildTask" checkGroup="childTasks" [item]="task" *ngFor="let task of pageOfTasks?.content"
                               [customClickHandler]="true" [fullDate]="true"></app-task-list-element>
    </div>
</ng-template>

<!--Фильтрация задач-->
<ng-template #filter>
    <div class="filters" [formGroup]="mainFilterForm">
        <div class="flexed column gap5">
            <span class="caption-header">Тип задачи</span>
            <p-listbox [checkbox]="true" [filter]="true"
                       [listStyle]="{'max-height':'20vh'}" [multiple]="true"
                       [options]="(templates$ | async)??[]" class="indent1" filterBy="name"
                       formControlName="template" optionLabel="name" optionValue="wireframeId"></p-listbox>
        </div>
        <div class="flexed column gap5" *ngIf="!onlyMy">
            <span class="caption-header">Статус задачи</span>
            <app-task-status-chooser formControlName="status"></app-task-status-chooser>
        </div>
        <input pInputText formControlName="globalContext" placeholder="Общий поиск"/>
        <p-dropdown [options]="(employees$ | async)??[]" [showClear]="true"
                    appendTo="body" formControlName="author" placeholder="Автор задачи"
                    styleClass="full-width" optionValue="login">
            <ng-template let-item pTemplate="item">
                <app-employee-label [employee]="item"></app-employee-label>
            </ng-template>
            <ng-template let-item pTemplate="selectedItem">
                <app-employee-label [employee]="item"></app-employee-label>
            </ng-template>
        </p-dropdown>
        <p-calendar [readonlyInput]="true" [showClear]="true" [selectOtherMonths]="true" appendTo="body"
                    formControlName="dateOfCreation" placeholder="Дата создания" selectionMode="range"
                    styleClass="full-width"></p-calendar>
        <app-task-tag-filter-input class="full-width" formControlName="tags"></app-task-tag-filter-input>
        <p-button label="Применить" icon="mdi-filter_alt" (onClick)="applyFilter()" *ngIf="mainFilterChanged"
                  [disabled]="!mainFilterForm.valid" [loading]="loading"></p-button>
    </div>
</ng-template>

<!--Выбор страницы с задачами-->
<ng-template #paginator>
    <p-paginator (onPageChange)="changePage($event)" [alwaysShow]="true"
                 [rows]="TASK_PAGE_SIZE" [showCurrentPageReport]="true"
                 [totalRecords]="pageOfTasks?.totalElements ?? 0"
                 currentPageReportTemplate="Показано с {first} по {last} из {totalRecords} задач"
                 styleClass="back-blured" class="paginator"></p-paginator>
</ng-template>


