<div appExtendPageHeight class="flexed">
    <app-main-menu-panel></app-main-menu-panel>

    <div class="flexed column stretched">
        <div class="flexed gap5 p10 vcenter hcenter">
            <app-text-search-input (onClear)="findGlobal()" (onSearch)="findGlobal()"
                                   [(value)]="globalSearchValue"></app-text-search-input>
            <span class="caption-sub-header flexed column hcenter">
                <p-inputSwitch (onChange)="findGlobal()" [(ngModel)]="showDeleted" [falseValue]="false"
                               [ngStyle]="{lineHeight:'0'}"
                               [trueValue]="true"></p-inputSwitch>
                Показывать удаленные?
            </span>
            <span>
                <app-button (onClick)="openEmployeeCreator()" icon="person_add" label="Создать"
                            model="p-button-text p-button-success"></app-button>
            </span>
        </div>
        <div class="employee-list">
            <div *ngFor="let employee of employees" class="employee-list-item">
                <app-avatar [deleted]="employee.deleted ?? false" [size]="2.5" [name]="employee | eplName" [src]="employee.avatar"></app-avatar>
                <div class="flexed column">
                    <span class="caption-main">{{employee | eplName}}</span>
                    <div class="flexed gap5 hcenter">
                        <span appColorize>
                            {{employee.department?.name}}
                        </span>
                        <span appColorize>
                            {{employee.position?.name}}
                        </span>
                    </div>
                </div>
                <div class="stretched"></div>
                <app-icon-button icon="edit" model="secondary" [disabled]="employee.deleted ?? false" (onClick)="openEmployeeEditor(employee.login)"></app-icon-button>
                <app-icon-button icon="delete" model="danger" [disabled]="employee.deleted ?? false" (onClick)="employeeDeleteConfirm(employee)"
                                 [loading]="employee.login ? isBeginDeleteEmployee[employee.login] : false"></app-icon-button>
            </div>
        </div>
    </div>
    <p-tabView class="department-menu">
        <p-tabPanel>
            <ng-template pTemplate="header">
                <div class="flexed gap3 hcenter">
                    <span [style.width]="'1.8rem'" class="material-icons-round">
                        groups
                    </span>
                    <span>
                        Отделы
                    </span>
                </div>
            </ng-template>
            <div class="flexed column gap10">
                <div>
                    <app-button (onClick)="openDepartmentCreator()" icon="group_add" label="Создать"
                                model="p-button-success"></app-button>
                </div>
                <div class="list-view">
                    <div *ngFor="let department of departments$ | async" class="list-view-item bordered">
                        <div class="flexed column gap5">
                                <span appColorize class="caption-sub-header">
                                    {{department.name}}
                                </span>
                            <div *ngIf="department.description" [style]="{maxWidth:'20rem',marginLeft:'.5rem'}"
                                 class="caption-main-small">
                                {{department.description}}
                            </div>
                        </div>
                        <div class="stretched"></div>
                        <app-icon-button
                                (onClick)="openDepartmentEditor(department.name??'', department.description??'', department.departmentId)"
                                [size]="1.4" icon="edit"
                                model="secondary"></app-icon-button>
                        <app-icon-button (onClick)="departmentDeleteConfirm(department)"
                                         [loading]="department.departmentId ? isBeginDeleteDepartment[department.departmentId] : false"
                                         [size]="1.4"
                                         icon="delete"
                                         model="danger"></app-icon-button>
                    </div>
                </div>
            </div>
        </p-tabPanel>
        <p-tabPanel>
            <ng-template pTemplate="header">
                <div [style]="{height:'1.8rem'}" class="flexed gap3 hcenter">
                    <span [style]="{width:'1.5rem', fontSize:'1.5rem'}" class="material-icons-round">
                        badge
                    </span>
                    <span>
                        Должности
                    </span>
                </div>
            </ng-template>
            <div class="flexed gap10 column">
                <app-button (onClick)="openPositionCreator()" icon="add" label="Создать"
                            model="p-button-success"></app-button>
                <div class="list-view">
                    <div *ngFor="let position of positions$ | async" class="list-view-item bordered">
                        <div class="flexed column gap5">
                                <span appColorize class="caption-sub-header">
                                    {{position?.name}}
                                </span>
                            <div *ngIf="position.description" [style]="{maxWidth:'20rem',marginLeft:'.5rem'}"
                                 class="caption-main-small">
                                {{position.description}}
                            </div>
                        </div>
                        <div class="stretched"></div>
                        <app-icon-button
                                (onClick)="openPositionEditor(position.name??'', position.description??'', position.access??0, position.positionId)"
                                [size]="1.4" icon="edit"
                                model="secondary"></app-icon-button>
                        <app-icon-button (onClick)="positionDeleteConfirm(position)"
                                         [loading]="position.positionId ? isBeginDeletePosition[position.positionId] : false"
                                         [size]="1.4"
                                         icon="delete"
                                         model="danger"></app-icon-button>
                    </div>
                </div>
            </div>
        </p-tabPanel>
    </p-tabView>
</div>

<p-dialog [(visible)]="showCreateDepartmentDialog" [modal]="true" [resizable]="false" header="Создание отдела">
    <ng-template pTemplate="content">
        <form [formGroup]="departmentForm" class="flexed column gap5">
            <span class="input-label-wrapper">
                <label>Название</label>
                <input formControlName="name" pInputText type="text">
            </span>
            <span class="input-label-wrapper">
                <label>Описание</label>
                <textarea [autoResize]="true" [cols]="50" [rows]="5" formControlName="description"
                          pInputTextarea></textarea>
            </span>
            <app-button (onClick)="departmentCreate()" [disabled]="!departmentForm.valid" icon="add"
                        label="Создать"></app-button>
        </form>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="showEditDepartmentDialog" [modal]="true" [resizable]="false" header="Редактирование отдела">
    <ng-template pTemplate="content">
        <form [formGroup]="departmentForm" class="flexed column gap5">
            <span class="input-label-wrapper">
                <label>Название</label>
                <input formControlName="name" pInputText type="text">
            </span>
            <span class="input-label-wrapper">
                <label>Описание</label>
                <textarea [autoResize]="true" [cols]="50" [rows]="5" formControlName="description"
                          pInputTextarea></textarea>
            </span>
            <app-button (onClick)="departmentEdit()" [disabled]="!departmentForm.valid" icon="save" label="Сохранить"
                        model="p-button-help"></app-button>
        </form>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="showCreatePositionDialog" [modal]="true" [resizable]="false" header="Создание должности">
    <ng-template pTemplate="content">
        <form [formGroup]="positionForm" class="flexed column gap5">
            <span class="input-label-wrapper">
                <label>Название</label>
                <input formControlName="name" pInputText type="text">
            </span>
            <span class="input-label-wrapper">
                <label>Описание</label>
                <textarea [autoResize]="true" [cols]="50" [rows]="5" formControlName="description"
                          pInputTextarea></textarea>
            </span>
            <p-panel header="Параметры доступа">
                <div class="flexed gap10 wrapped">
                    <p-checkbox *ngFor="let flag of accessFlags()" [label]="flag.name" [value]="flag.value"
                                formControlName="access" name="access"></p-checkbox>
                </div>
            </p-panel>
            <app-button (onClick)="positionCreate()" [disabled]="!positionForm.valid" icon="add"
                        label="Создать"></app-button>
        </form>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="showEditPositionDialog" [modal]="true" [resizable]="false" header="Редактирование должности">
    <ng-template pTemplate="content">
        <form [formGroup]="positionForm" class="flexed column gap5">
            <span class="input-label-wrapper">
                <label>Название</label>
                <input formControlName="name" pInputText type="text">
            </span>
            <span class="input-label-wrapper">
                <label>Описание</label>
                <textarea [autoResize]="true" [cols]="50" [rows]="5" formControlName="description"
                          pInputTextarea></textarea>
            </span>
            <p-panel header="Параметры доступа">
                <div class="flexed gap10 wrapped">
                    <p-checkbox *ngFor="let flag of accessFlags()" [label]="flag.name" [value]="flag.value"
                                formControlName="access" name="access"></p-checkbox>
                </div>
            </p-panel>
            <app-button (onClick)="positionEdit()" [disabled]="!positionForm.valid" icon="save" label="Сохранить"
                        model="p-button-help"></app-button>
        </form>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="showCreateEmployeeDialog" [modal]="true" [resizable]="false" header="Создание сотрудника">
    <ng-template pTemplate="content">
        <form [formGroup]="employeeForm" class="flexed column gap5">
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper full-width">
                    <label>Фамилия</label>
                    <input appRegexPatternChecker formControlName="lastName" pInputText patternRx="^[А-я]+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Имя</label>
                    <input appRegexPatternChecker formControlName="firstName" pInputText patternRx="^[А-я]+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Отчество</label>
                    <input appRegexPatternChecker formControlName="secondName" pInputText patternRx="^[А-я]+$"
                           type="text">
                </span>
            </div>
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper full-width">
                    <label>Логин</label>
                    <input appRegexPatternChecker formControlName="login" pInputText patternRx="^[A-z\d\.-_]+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Пароль</label>
                    <input appRegexPatternChecker formControlName="password" pInputText patternRx="^[A-z\d\.-_]+$"
                           type="text">
                </span>
            </div>
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper full-width">
                    <label>Внутренний номер телефона</label>
                    <input appRegexPatternChecker formControlName="internalPhoneNumber" pInputText patternRx="^\d+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Telegram ID</label>
                    <input appRegexPatternChecker formControlName="telegramUserId" pInputText patternRx="^\d+$"
                           type="text">
                </span>

            </div>
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper">
                    <label>Отдел</label>
                    <p-dropdown [options]="(departments$ | async)??[]" formControlName="department"
                                optionLabel="name" optionValue="departmentId" placeholder="Выбрать">
                        <ng-template let-department pTemplate="selectedItem">
                            <div [colorString]="department.name" appColorize>{{department.name}}</div>
                        </ng-template>
                        <ng-template let-department pTemplate="item">
                            <div appColorize>{{department.name}}</div>
                        </ng-template>
                    </p-dropdown>
                </span>
                <span class="input-label-wrapper">
                    <label>Должность</label>
                    <p-dropdown (onChange)="positionSelecting($event)" [options]="(positions$ | async)??[]" formControlName="position"
                                optionLabel="name" optionValue="positionId" placeholder="Выбрать">
                        <ng-template let-position pTemplate="selectedItem">
                            <div [colorString]="position.name" appColorize>
                                {{position.name}}
                            </div>
                        </ng-template>
                        <ng-template let-position pTemplate="item">
                            <div appColorize>
                                {{position.name}}
                            </div>
                        </ng-template>
                    </p-dropdown>
                </span>
                <span class="input-label-wrapper flexed vcenter">
                    <label>Монтажник?</label>
                    <p-inputSwitch [falseValue]="false" [ngStyle]="{lineHeight:'0'}" [trueValue]="true"
                                   formControlName="offsite"></p-inputSwitch>
                </span>
            </div>
            <p-panel header="Параметры доступа">
                <div class="flexed gap10 column">
                    <div class="flexed gap10 hcenter">
                        <p-toggleButton (onChange)="checkAllAccess($event)" [disabled]="!isAccessOverride" offLabel="Выделить всё"
                                        onLabel="Снять выделение"></p-toggleButton>
                        <p-toggleButton (ngModelChange)="accessOverrideChange($event)" [(ngModel)]="isAccessOverride"
                                        [ngModelOptions]="{standalone:true}" offLabel="Переопределить"
                                        onLabel="Из должности"></p-toggleButton>
                    </div>
                    <div *ngIf="isAccessOverride" class="flexed gap10 wrapped">
                        <p-checkbox *ngFor="let flag of accessFlags()" [label]="flag.name" [value]="flag.value"
                                    formControlName="access" name="access"></p-checkbox>
                    </div>
                    <div *ngIf="!isAccessOverride" class="flexed gap10 wrapped">
                        <p-checkbox *ngFor="let flag of accessFlags(); trackBy: accessFlagTrackBy" [disabled]="true"
                                    [label]="flag.name"
                                    [ngModelOptions]="{standalone:true}" [ngModel]="accessOfSelectedPosition"
                                    [value]="flag.value" name="accessPosition"></p-checkbox>
                    </div>
                </div>
            </p-panel>
            <app-button (onClick)="employeeCreate()" [disabled]="!employeeForm.valid" icon="person_add"
                        label="Создать"></app-button>
        </form>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="showEditEmployeeDialog" [modal]="true" [resizable]="false" header="Редактирование сотрудника">
    <ng-template pTemplate="content">
        <form [formGroup]="employeeForm" class="flexed column gap5">
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper full-width">
                    <label>Фамилия</label>
                    <input appRegexPatternChecker formControlName="lastName" pInputText patternRx="^[А-я]+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Имя</label>
                    <input appRegexPatternChecker formControlName="firstName" pInputText patternRx="^[А-я]+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Отчество</label>
                    <input appRegexPatternChecker formControlName="secondName" pInputText patternRx="^[А-я]+$"
                           type="text">
                </span>
            </div>
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper full-width">
                    <label>Логин</label>
                    <input appRegexPatternChecker formControlName="login" pInputText patternRx="^[A-z\d\.-_]+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Пароль</label>
                    <input appRegexPatternChecker formControlName="password" pInputText patternRx="^[A-z\d\.-_]+$"
                           type="password">
                </span>
            </div>
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper full-width">
                    <label>Внутренний номер телефона</label>
                    <input appRegexPatternChecker formControlName="internalPhoneNumber" pInputText patternRx="^\d+$"
                           type="text">
                </span>
                <span class="input-label-wrapper full-width">
                    <label>Telegram ID</label>
                    <input appRegexPatternChecker formControlName="telegramUserId" pInputText patternRx="^\d+$"
                           type="text">
                </span>

            </div>
            <div class="flexed gap10 hcenter">
                <span class="input-label-wrapper">
                    <label>Отдел</label>
                    <p-dropdown [options]="(departments$ | async)??[]" formControlName="department"
                                optionLabel="name" optionValue="departmentId" placeholder="Выбрать">
                        <ng-template let-department pTemplate="selectedItem">
                            <div [colorString]="department.name" appColorize>{{department.name}}</div>
                        </ng-template>
                        <ng-template let-department pTemplate="item">
                            <div appColorize>{{department.name}}</div>
                        </ng-template>
                    </p-dropdown>
                </span>
                <span class="input-label-wrapper">
                    <label>Должность</label>
                    <p-dropdown (onChange)="positionSelecting($event)" [options]="(positions$ | async)??[]" formControlName="position"
                                optionLabel="name" optionValue="positionId" placeholder="Выбрать">
                        <ng-template let-position pTemplate="selectedItem">
                            <div [colorString]="position.name" appColorize>
                                {{position.name}}
                            </div>
                        </ng-template>
                        <ng-template let-position pTemplate="item">
                            <div appColorize>
                                {{position.name}}
                            </div>
                        </ng-template>
                    </p-dropdown>
                </span>
                <span class="input-label-wrapper flexed vcenter">
                    <label>Монтажник?</label>
                    <p-inputSwitch [falseValue]="false" [ngStyle]="{lineHeight:'0'}" [trueValue]="true"
                                   formControlName="offsite"></p-inputSwitch>
                </span>
            </div>
            <p-panel header="Параметры доступа">
                <div class="flexed gap10 column">
                    <div class="flexed gap10 hcenter">
                        <p-toggleButton (onChange)="checkAllAccess($event)" [disabled]="!isAccessOverride" offLabel="Выделить всё"
                                        onLabel="Снять выделение"></p-toggleButton>
                        <p-toggleButton (ngModelChange)="accessOverrideChange($event)" [(ngModel)]="isAccessOverride"
                                        [ngModelOptions]="{standalone:true}" offLabel="Переопределить"
                                        onLabel="Из должности"></p-toggleButton>
                    </div>
                    <div *ngIf="isAccessOverride" class="flexed gap10 wrapped">
                        <p-checkbox *ngFor="let flag of accessFlags()" [label]="flag.name" [value]="flag.value"
                                    formControlName="access" name="access"></p-checkbox>
                    </div>
                    <div *ngIf="!isAccessOverride" class="flexed gap10 wrapped">
                        <p-checkbox *ngFor="let flag of accessFlags(); trackBy: accessFlagTrackBy" [disabled]="true"
                                    [label]="flag.name"
                                    [ngModelOptions]="{standalone:true}" [ngModel]="accessOfSelectedPosition"
                                    [value]="flag.value" name="accessPosition"></p-checkbox>
                    </div>
                </div>
            </p-panel>
            <app-button (onClick)="employeeEdit()" [disabled]="!employeeForm.valid" icon="save"
                        label="Сохранить"></app-button>
        </form>
    </ng-template>
</p-dialog>

